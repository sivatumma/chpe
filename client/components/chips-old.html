<link rel="import"  href="../bower_components/iron-a11y-keys-behavior/iron-a11y-keys-behavior.html">

<dom-module id="multi-value-suggestbox">

 <template >
        <style type="text/css" media="screen">
            ul {
                margin: 0;
                padding: 0;
                list-style: none;
                font-family: "Calibri";
            }
            ul#item_list {
                display: block;
                border-bottom: 2px solid rgb(63,81,181);
                min-width: 50%;
                padding-left: 10px;
            }
            ul#item_list > li {
                display: inline-block;
                position: relative;
                vertical-align: middle;
            }
            ul#item_list > li:not(#item_entry) {
                border: 1px solid #ccd5e4;
                border-radius:16px;
                background-color:rgb(224,224,224);
                font-size: 14px;
                color: rgb(66,66,66);;
                text-overflow: ellipsis;
                overflow: hidden;
                cursor: default;
                    height: 24px;
                    line-height: 24px;
                    margin: 5px;
                    padding: 0px 10px 0px 6px
            }
            ul#item_list > li > a {
              
                font-size: 14px;
                font-weight: bold;
                color: #000;
                text-decoration: none;
                line-height: 8px;
                margin-left: 12px;
                width: 10px;
                cursor: pointer;
            }
            ul#item_list > li > a::after {
                content: 'X';
            }
            #item_entry {
                position: relative;
            }
            #item_entry > div {
                display: inline;
                padding: 3px 5px;
                box-sizing: border-box;
                line-height: 50px;
            }
            #item_entry > div > span {
                min-width: 60px;
                display: inline-block;
                font-size: 14px;
                line-height: 150%;
                vertical-align: middle;
            }
            #item_entry > div > span:focus {
                outline-style: none;
            }
            ul#suggest_menu {
                display: block;
                position: absolute;
                left: 4px;
                -webkit-box-shadow: 0px 4px 6px 0px rgba(50, 50, 50, 0.75);
                -moz-box-shadow:    0px 4px 6px 0px rgba(50, 50, 50, 0.75);
                box-shadow:  box-shadow: 12px 0 20px -4px #ccc, -12px 0 15px -4px #ccc;
                background-color: #ffffff;
                min-width: 200px;
            }
            ul#suggest_menu li {
                min-width: 100%;
                padding: 7px 10px;
                box-sizing: border-box;
                font-size: 14px;
                cursor: pointer;
                border-bottom: 1px solid #d4d4d4
            }
            ul#suggest_menu li.active {
                background-color: #7bae4d;
                color:#fff;
            }
        </style>

        <div options="{{listOptions}}" suggestions="{{listSuggestions}}">
             <ul id="item_list" style="width: {{options.box_width}};" on-tap="elementTapped">
            <template repeat="{{item in selectedItems}}">
                <li style="max-width: calc( {{options.box_width}} - 25px);">{{item}}<a on-tap="removeTapped"></a></li>
            </template>
            <li id="item_entry">
                <div style="line-height: {{options.box_height}};">
                    <span id="item_input"
                        style="max-width: calc( {{options.box_width}} - 5px);"
                        contenteditable="true"
                        on-keydown="keydownHandler"
                        on-keyup="keyupHandler">
                    </span>
                </div>
                <template if="{{suggestions.length >= 0}}">
                    <ul id="suggest_menu">
                        <template repeat="{{item in suggestions}}">
                            <li on-tap="suggestionTapped"
                                on-mouseover="suggestionHovered">{{item}}</li>
                        </template>
                    </ul>
                </template>
            </li>
        </ul>
        </div>
       
        <!-- <core-xhr id="xhr"></core-xhr> -->
    </template>

    <script>
        var calculateLiIndex = function(item) {
            var index = 0;
            while((item = item.previousSibling) !== null) {
                if (item.nodeType === 1 && item.tagName.toLowerCase() === 'li') {
                    index++;
                }
            }
            return index;
        };

        var getPreviousLi = function(item) {
            var previousLi = null;
            if (item) {
                while((item = item.previousSibling) !== null) {
                    if (item.nodeType === 1 && item.tagName.toLowerCase() === 'li') {
                        previousLi = item;
                        break;
                    }
                }
            }
            return previousLi;
        };

        var addClass = function(element, cName) {
            if (element) {
                if (element.className.length > 0) {
                    element.className += ' ';
                }
                element.className += cName;
            }
        };

        var removeClass = function(element, cName) {
            if (element) {
                element.className = element.className.replace(new RegExp('(?:^|\\s)'+cName+'(?!\\S)'), '');
            }
        };

        Polymer({
            is:'multi-value-suggestbox', 
            properties:{
                listSuggestions: Array ,
                selectedItems: Array,
                listOptions: Object,
            },
            listeners: {
                /*'tap':'elementTapped',
                'suggest_menu.tap':'suggestionTapped',
                'item_input.keydown':'keydownHandler',
                'item_input.keyup':'keyupHandler',
                'suggest_menu.mouseover':'suggestionHovered',*/
                
            },
            // Fires when the "<multi-value-suggestbox>" has been fully prepared
            ready: function() {
                // if not set by user, use default values
                /*if (options.box_width) this.options.box_width = "200px";
                if (options.box_height) this.options.box_height = "40px";
                if (options.allow_space) this.options.allow_space = false;
                if (options.allow_nonmatching) this.options.allow_nonmatching = false;*/
                this.addEventListener('input-changed', function(ele) {
                     var el = document.querySelector('#multi_suggest');
                    el.suggestions = ["Suresh","Siva","Mahesh"];
                  });
            },

            test:function(ele) {
                    var that = this;
                   /* this.$.xhr.request({url:((this.attributes.url.value)+ele.detail.newInput), callback: this.handleResponse})*/
                    var el = document.querySelector('#multi_suggest');
                   el.suggestions = ["Suresh","Siva","Mahesh"];
                  },

            loadChips:function(response){
                var contacts = JSON.parse(response);
                    return contacts.map(function(c, index) {
                        var cParts = c.split(' ');
                        var contact = {
                            name: c
                        };
                        contact._lowername = contact.name.toLowerCase();
                        return contact;
                 });
                console.log("This is running");
            },

            handleResponse: function(response) {
                        var el = document.querySelector('#multi_suggest');
                        //el.suggestions = JSON.parse(response);
                        var contacts = JSON.parse(response);
                        var chips = [];
                       contacts.map(function(c, index) {
                        var contact = {
                            name: c,
                            id: (c.id)||index
                        };
                        contact._lowername = contact.name.toLowerCase();
                        chips.push(contact);
                    });
                       el.suggestions = chips;
                  //console.log(chips);
                       
             },
      
            elementTapped: function(event, detail, sender) {
                this.setFocus();
            },

            suggestionTapped: function(event, detail, sender) {
                this.selectedItems.push(event.target.innerText);
                // reset input
                this.$.item_input.innerText = '';

                this.resetSuggestions();
            },

            suggestionHovered: function(event, detail, sender) {
                removeClass(this.$.item_list.querySelector('#suggest_menu li.active'), 'active');
                addClass(sender, 'active');
            },

            removeTapped: function(event, detail, sender) {
                this.selectedItems.splice(calculateLiIndex(sender.parentNode), 1);
            },

            keydownHandler: function(event, detail, sender) {
               // console.log();
                var activeSuggestion;
                switch(event.keyCode) {
                    case 8:  // backspace
                        if (event.target.innerText.length === 0 && this.selectedItems.length > 0) {
                            this.selectedItems.pop();
                        }
                        break;

                    case 32:  // spacebar
                        if (this.options.allow_space === true) {
                            break;
                        }
                        // else fall through
                    case 13:  // enter
                        activeSuggestion = this.$.item_list.querySelector('#suggest_menu li.active');
                        var topSuggestion = this.$.item_list.querySelector('#suggest_menu li');
                        if (activeSuggestion) {
                            console.log(this.selectedItems);
                            this.selectedItems.push(activeSuggestion.innerText);
                            this.$.item_input.innerText = '';
                            this.resetSuggestions();
                        } else if ((this.options.allow_nonmatching === true && this.$.item_input.innerText.length > 0) ||
                                this.$.item_input.innerText === topSuggestion.innerText) {
                            this.selectedItems.push(event.target.innerText);
                            this.$.item_input.innerText = '';
                            this.resetSuggestions();
                        }
                        inputChanged = false;
                        event.preventDefault();
                        break;

                    case 27:  // escape
                        if (this.options.allow_nonmatching === true || this.suggestions.length > 0) {
                            this.resetSuggestions();
                            event.preventDefault();
                        }
                        inputChanged = false;
                        break;

                    case 38:  // up arrow
                        activeSuggestion = this.$.item_list.querySelector('#suggest_menu li.active');
                        var prev = getPreviousLi(activeSuggestion);
                        removeClass(activeSuggestion, 'active');
                        if (prev) {
                            addClass(prev, 'active');
                        } else {
                            addClass(this.$.item_list.querySelector('#suggest_menu li:last-of-type'), 'active');
                        }
                        inputChanged = false;
                        break;

                    case 40:  // down arrow
                        activeSuggestion = this.$.item_list.querySelector('#suggest_menu li.active');
                        var next = this.$.item_list.querySelector('#suggest_menu li.active ~ li');
                        removeClass(activeSuggestion, 'active');
                        if (next) {
                            addClass(next, 'active');
                        } else {
                            addClass(this.$.item_list.querySelector('#suggest_menu li'), 'active');
                        }
                        inputChanged = false;
                        break;
                }
            },

            keyupHandler: function(event, detail, sender) {
                var inputChanged = true;
                var activeSuggestion;
                switch(event.keyCode) {
                    case 8:  // backspace
                        if (event.target.innerText.length === 0) {
                            inputChanged = false;
                        }
                        break;

                    case 9:  // tab
                    case 13:  // enter
                    case 16:  // shift
                    case 17:  // ctrl
                    case 18:  // alt
                    case 27:  // escape
                    case 37:  // left arrow
                    case 38:  // up arrow
                    case 39:  // right arrow
                    case 40:  // down arrow
                        inputChanged = false;
                        break;
                }

                if (inputChanged === true) {
                    this.fireInputChangedEvent();
                }
            },

            fireInputChangedEvent: function() {
                this.fire('input-changed', { newInput: this.$.item_input.innerText });
            },

            resetSuggestions: function() {
                while (this.suggestions.length > 0) {
                    this.suggestions.pop();
                }
            },

            setFocus: function() {
                this.$.item_input.focus();
            }
        });

    
    
    </script>

</dom-module>